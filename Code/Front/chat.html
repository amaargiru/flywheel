<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>English Flywheel. Chat</title>
  <link rel="icon" type="image/png" href="images/icon.png" />
  <link href="styles/style.css" rel="stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css2?family=Roboto' rel='stylesheet' type='text/css'>
</head>

<body onload="startMessage()">
  <div id="wrapper">
    <div id="menu">
      <p class="welcome" id="header"><b>Flywheel Bot</b></p>
    </div>
    <div id="chatbox"></div>

    <input name="usermsg" type="text" id="usermsg" />
    <input type="submit" id="submitmsg" onclick="updateChat()" value="Send" />
  </div>
</body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript">
  question_id = 1;

  const node = document.getElementById('usermsg');
  node.addEventListener("keyup", function (event) {
    if (event.key === "Enter") {
      updateChat();
    }
  });

  async function updateChat() {
    document.getElementById('chatbox').innerHTML += `<div class="chat__item chat__item--responder">
      <img src="images/user_small.png" class="chat__person-avatar">
      <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">9:05</div>
      <div class="chat__message-content">${document.getElementById('usermsg').value}</div></div></div></div>`

    chainReq();
    document.getElementById('usermsg').value = "";
    return false;
  }

  function startMessage() {
    if (localStorage.getItem("flywheelJwtToken") === null) {
      document.getElementById('chatbox').innerHTML += ` <div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">9:03</div>
        <div class="chat__message-content">
          Привет! Вы можете <a href="signin.html">войти в свой аккаунт</a> или <a href="signup.html">создать новый аккаунт</a>. 
          Тогда бот определит темы занятий именно под ваш уровень владения английским языком, 
          каждый следующий вопрос будет подобран индивидуально и ваш прогресс значительно ускорится.<br>
          Если вы продолжите учиться без аккаунта, то, к сожалению, вопросы будут задаваться в случайном порядке, 
          а информация о вашем прогрессе не будет сохранена.
        </div></div></div></div>`
    }

    axios.defaults.headers.post['Access-Control-Allow-Origin'] = '*';
    axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
    return axios.post("http://127.0.0.1:8000/get_next_question_anonymous?user_id=1")
      .then(response => {
        console.log(response.data);
        document.getElementById('chatbox').innerHTML += ` <div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">9:03</div>
        <div class="chat__message-content">Напишите на английском фразу <b>\"${response.data.native_phrase}\"</b>.</div></div></div></div>`

        question_id = response.data.question_id

        var objDiv = document.getElementById("chatbox");
        objDiv.scrollTop = objDiv.scrollHeight;
      })
      .catch(error => console.error(error));
  }

  function chainReq() {
    axios.defaults.headers.post['Access-Control-Allow-Origin'] = '*';
    axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';

    axios.all(
      [axios.post(`http://127.0.0.1:8000/get_answer_check_anonymous?user_id=1&question_id=${question_id}&user_input=${(document.getElementById('usermsg').value)}`),
      axios.post("http://127.0.0.1:8000/get_next_question_anonymous?user_id=1")])
      .then(axios.spread((firstResponse, secondResponse) => {
        console.log(firstResponse.data, secondResponse.data);

        var asa = JSON.parse(firstResponse.data.answer);

        hint = "";
        for (var i = 0; i < asa.hint.length; i++) {
          b = asa.hint.charAt(i);
          if (b == '/') {
            hint += `<font color="red">${asa.hint.charAt(i + 1)}</font>`
            i++;
          }
          else
            hint += `<font color="green">${asa.hint.charAt(i)}</font>`
        }
        document.getElementById('chatbox').innerHTML += ` <div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">9:03</div>
        <div class="chat__message-content">Правильный ответ: ${hint}</div></div></div></div>`

        console.log(secondResponse.data);
        document.getElementById('chatbox').innerHTML += ` <div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">9:03</div>
        <div class="chat__message-content">Напишите на английском фразу <b>\"${secondResponse.data.native_phrase}\"</b>.</div></div></div></div>`

        question_id = secondResponse.data.question_id

        var objDiv = document.getElementById("chatbox");
        objDiv.scrollTop = objDiv.scrollHeight;
      }))
      .catch(error => console.log(error));
  }
</script>

</html>