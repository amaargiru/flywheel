<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>English Flywheel. Chat</title>
  <link rel="icon" type="image/png" href="images/icon.png" />
  <link href="styles/style.css" rel="stylesheet" type="text/css">
</head>

<body onload="startMessage()">
  <div id="wrapper">
    <div id="menu">
      <p class="welcome" id="header"><b>Flywheel Bot</b></p>
      <a href="signin.html">Вход</a> &nbsp;&nbsp;&nbsp; <a href="signup.html">Регистрация</a>
    </div>
    <div id="chatbox"></div>

    <div class="usermsgwrapper">
      <input class="usermsg" name="usermsg" type="text" id="usermsg" />
      <input class="submitmsg" type="submit" id="submitmsg" onclick="updateChat()" value="Send" />
    </div>
  </div>
</body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript">
  question_id = 1;

  const usermsgnode = document.getElementById('usermsg');
  usermsgnode.addEventListener("keyup", function (event) {
    if (event.key === "Enter") {
      updateChat();
    }
  });

  async function updateChat() {
    document.getElementById('chatbox').innerHTML += `<div class="chat__item chat__item--responder">
      <img src="images/user_small.png" class="chat__person-avatar">
      <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">${getcurrentTime()}</div>
      <div class="chat__message-content">${document.getElementById('usermsg').value}</div></div></div></div>`

    chainReq();
    document.getElementById('usermsg').value = "";
    return false;
  }

  function startMessage() {
    if (localStorage.getItem("flywheelJwtToken") === null) {
      document.getElementById('chatbox').innerHTML += `<div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">${getcurrentTime()}</div>
        <div class="chat__message-content">
          Привет! Вы можете <a href="signin.html">войти в свой аккаунт</a> или <a href="signup.html">создать новый аккаунт</a>. 
          Тогда бот определит темы занятий именно под ваш уровень владения английским языком, 
          каждый следующий вопрос будет подобран индивидуально и ваш прогресс значительно ускорится.<br>
          Если вы продолжите учиться без аккаунта, то, к сожалению, вопросы будут задаваться в случайном порядке, 
          а информация о вашем прогрессе не будет сохранена.
        </div></div></div></div>`
    }

    if (localStorage.getItem("flywheelJwtToken") === null)
      req = "http://127.0.0.1:8000/get_next_question_anonymous?user_id=1";
    else {
      req = "http://127.0.0.1:8000/get_next_question";
      axios.defaults.headers.post['Authorization'] = `Bearer ${localStorage.getItem('flywheelJwtToken')}`;
    }

    axios.defaults.headers.post['Access-Control-Allow-Origin'] = '*';
    axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';
    return axios.post(req)
      .then(response => {
        console.log(response.data);
        document.getElementById('chatbox').innerHTML += ` <div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">${getcurrentTime()}</div>
        <div class="chat__message-content">Напишите на английском фразу <b>\"${response.data.native_phrase}\"</b>.</div></div></div></div>`

        question_id = response.data.question_id

        var objDiv = document.getElementById("chatbox");
        objDiv.scrollTop = objDiv.scrollHeight;
      })
      .catch(error => console.error(error));
  }

  function chainReq() {
    axios.defaults.headers.post['Access-Control-Allow-Origin'] = '*';
    axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded';

    if (localStorage.getItem("flywheelJwtToken") === null) {
      req1 = `http://127.0.0.1:8000/get_answer_check_anonymous?user_id=1&question_id=${question_id}&user_input=${(document.getElementById('usermsg').value)}`;
      req2 = "http://127.0.0.1:8000/get_next_question_anonymous?user_id=1";
    }
    else {
      req1 = `http://127.0.0.1:8000/get_answer_check?user_id=1&question_id=${question_id}&user_input=${(document.getElementById('usermsg').value)}`;
      req2 = "http://127.0.0.1:8000/get_next_question";
      axios.defaults.headers.post['Authorization'] = `Bearer ${localStorage.getItem('flywheelJwtToken')}`;
    }

    axios.all(
      [axios.post(req1), axios.post(req2)])
      .then(axios.spread((firstResponse, secondResponse) => {
        console.log(firstResponse.data, secondResponse.data);

        let ans = JSON.parse(firstResponse.data.answer);
        let motivation_msg = "";
        switch (ans.score) {
          case 4:
            motivation_msg = "Правильно!";
            break;
          case 3:
            motivation_msg = "Почти правильно. Правильный ответ:";
            break;
          case 2:
            motivation_msg = "Неплохо. Правильный ответ:";
            break;
          case 1:
            motivation_msg = "Правильный ответ:";
            break;
        }

        let hint = "";
        if ((ans.score >= 1) && (ans.score <= 3)) {
          for (let i = 0; i < ans.hint.length; i++) {
            b = ans.hint.charAt(i);
            if (b == '/') {
              hint += `<font color="red">${ans.hint.charAt(i + 1)}</font>`
              i++;
            }
            else
              hint += `<font color="green">${ans.hint.charAt(i)}</font>`
          }
        }

        document.getElementById('chatbox').innerHTML += ` <div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">${getcurrentTime()}</div>
        <div class="chat__message-content">${motivation_msg} ${hint}.</div></div></div></div>`

        console.log(secondResponse.data);
        document.getElementById('chatbox').innerHTML += ` <div class="chat__content"><div class="chat__item">
        <img src="images/icon_small.png" alt="Flywheel english bot" class="chat__person-avatar">
        <div class="chat__messages"><div class="chat__message"><div class="chat__message-time">${getcurrentTime()}</div>
        <div class="chat__message-content">Напишите на английском фразу <b>\"${secondResponse.data.native_phrase}\"</b>.</div></div></div></div>`

        question_id = secondResponse.data.question_id

        var objDiv = document.getElementById("chatbox");
        objDiv.scrollTop = objDiv.scrollHeight;
      }))
      .catch(error => console.log(error));
  }

  function getcurrentTime() {
    return new Date().toLocaleTimeString('en-US', {
      hour12: false,
      hour: "numeric",
      minute: "numeric"
    });
  }
</script>

</html>